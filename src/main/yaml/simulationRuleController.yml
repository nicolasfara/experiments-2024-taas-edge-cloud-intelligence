incarnation: surrogatescafi

variables:
  seed: &seed
    min: 0
    max: 0
    step: 1
    default: 0
  scenarioType: &scenarioType
    type: ArbitraryVariable
    parameters: [ "fulloffloadcloud", [ "fulllocal", "fulloffloadcloud", "fulloffloadedge" ] ] # TODO Sistemare offloading!
  #------------------------------------------------------------------
  gradientProgram: &gradientProgram
    language: scala
    formula: "\"it.unibo.alchemist.Gradient\""
  greaterDistance: &greaterDistance
    language: scala
    formula: "\"it.unibo.alchemist.GreaterDistance\""
  programDag: &programDag
    language: scala
    formula: Map(gradientProgram -> Set(greaterDistance))
  osInstructions: &osInstructions
    language: scala
    formula: 0L # 5_000_000L
  componentsInstructions: &componentsInstructions
    language: scala
    formula: |
      Map(gradientProgram -> 10_000_000L, greaterDistance -> 16_500_000L)
  cloudCost: &cloudCost 1000.0
  edgeCost: &edgeCost 100.0

seeds:
  scenario: *seed
  simulation: *seed

network-model:
  type: ConnectWithinDistancesEdge
  parameters: [2]

_constants:
  retentionTime: &retentionTime 25.0

_programs:
  - program: &surrogateGradient
      - time-distribution: 1
        type: Event
        actions:
          - type: RunSurrogateScafiProgram
            parameters: [ *gradientProgram, *retentionTime, *programDag ]
      - program: sendSurrogate
  - program: &surrogateGreater
    - time-distribution: 1
      type: Event
      actions:
        - type: RunSurrogateScafiProgram
          parameters: [ *greaterDistance, *retentionTime, *programDag ]
    - program: sendSurrogate
  - program: &gradient
      - time-distribution: 1
        type: Event
        actions:
          - type: RunApplicationScafiProgram
            parameters: [ *gradientProgram, *retentionTime, *programDag ]
      - program: send
  - program: &greater
      - time-distribution: 1
        type: Event
        actions:
          - type: RunApplicationScafiProgram
            parameters: [ *greaterDistance, *retentionTime, *programDag ]
      - program: send
  - program: &batteryDevice
      - time-distribution: 1
        type: Event
        actions:
          - type: BatteryEquippedDevice
            parameters: [ 4200.0, 1, *componentsInstructions, 100.0, 3.7, 0.5, *osInstructions ] # Battery capacity, EPI (nJ), components instructions
  - program: &payPerUseDevice
    - time-distribution: 1
      type: Event
      actions:
        - type: PayPerUseDevice
          parameters: [*edgeCost] # Cost per component per hour in $/h
  - program: &ruleControllerModularizationRuntime
    - time-distribution:
        type: Trigger
        parameters: [ 1 ]
      type: Event
      actions:
        - type: RuleControllerModularizationRuntime
          parameters: [ *programDag, *scenarioType ]
  - program: &payPerUseCloud
    - time-distribution: 1
      type: Event
      actions:
        - type: PayPerUseDevice
          parameters: [ *cloudCost ] # Cost per component per hour in $/h

launcher:
  parameters:
    batch: [seed, scenarioType]

environment:
  type: Continuous2DEnvironment
  parameters: []

_application-programs: &application-programs
  - *gradient
  - *greater
  - *batteryDevice
  - *ruleControllerModularizationRuntime

_application-allocation: &application-allocation
  type: AllocatorProperty
  parameters: [ *programDag ]

deployments:
  - type: Grid
    parameters: [ 0, 0, 2, 2, 0.5, 0.5, 0.5, 0.5]
    programs: *application-programs
    properties: *application-allocation
  - type: Grid
    parameters: [ 3, 3, 5, 5, 0.5, 0.5, 0.5, 0.5 ]
    programs: *application-programs
    properties: *application-allocation
  - type: Grid
    parameters: [ 0, 0, 6, 6, 1.5, 1.5, 2, 2 ]
    programs: *application-programs
    properties: *application-allocation
  - type: SpecificPositions # Edge Servers
    parameters: [
      [ 8.2152226, 6.3816613 ],
      [ 8.2366507, 6.3838339 ],
      [ 8.2146077, 6.3485146 ],
      [ 8.2055562, 6.3778687 ],
      [ 8.1924837, 6.3458967 ],
    ]
    programs:
      - *surrogateGradient
      - *surrogateGreater
      - *payPerUseDevice
    contents:
      - molecule: infrastructuralDevice
        concentration: true
  - type: SpecificPositions # Clouds
    parameters: [
      [ -0.5, 9.3816613 ],
      [ 0.5, 9.3838339 ],
    ]
    programs:
      - *surrogateGradient
      - *surrogateGreater
      - *payPerUseCloud
    contents:
      - molecule: cloudDevice
        concentration: true
      - molecule: cost
        concentration: *cloudCost

terminate:
  type: AfterTime
  parameters: 50

export:
  - type: CSVExporter
    parameters:
      fileNameRoot: "baseline-static-aggregated"
      interval: 1.0
      exportPath: "data"
    data:
      - time
      - molecule: batteryPercentage
        aggregators: [min, max, mean, variance]
        value-filter: onlyfinite
      - molecule: batteryCapacity
        aggregators: [min, max, mean, variance]
        value-filter: onlyfinite
      - molecule: localComponentsPercentage
        aggregators: [ min, max, mean, variance ]
        value-filter: onlyfinite
      - molecule: ComponentsExecutionCount
        aggregators: [ min, max, mean, variance ]
        value-filter: onlyfinite
      - molecule: cost
        aggregators: [ min, max, mean, variance ]
        value-filter: onlyfinite
      - molecule: totalCost
        aggregators: [ min, max, mean, variance ]
        value-filter: onlyfinite
  - type: CSVExporter
    parameters:
     fileNameRoot: "baseline-static-nodes"
     interval: 1.0
     exportPath: "data"
    data:
     - time
     - type: NodesPositions
     - type: MoleculePerNodeExtractor
       parameters: [ "batteryPercentage", 3 ]
     - type: MoleculePerNodeExtractor
       parameters: [ "batteryCapacity", 3 ]
     - type: MoleculePerNodeExtractor
       parameters: [ "localComponentsPercentage", 3 ]
     - type: MoleculePerNodeExtractor
       parameters: [ "ComponentsExecutionCount", 3 ]